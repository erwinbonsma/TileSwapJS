<html>
<head>
<title>Tile Swap</title>
</head>
<body>

<h1>Puzzle</h1>

<table border="1">
<tr>
<td><canvas id="tile0" width="56" height="56"/></td>
<td><button onclick="trySwapTiles(0, 1)">-</button></td>
<td><canvas id="tile1" width="56" height="56"/></td>
</tr>
<tr>
<td><button onclick="trySwapTiles(0, 2)">|</button></td>
<td/>
<td><button onclick="trySwapTiles(1, 3)">|</button></td>
</tr>
<tr>
<td><canvas id="tile2" width="56" height="56"/></td>
<td><button onclick="trySwapTiles(2, 3)">-</button></td>
<td><canvas id="tile3" width="56" height="56"/></td>
</tr>
</table>

<p id="status">...</p>

<button onclick="resetPuzzle()">Reset</button>

<button onclick="init()">Initialize</button>

</body>

<script>
var numCols = 2;
var numRows = 2;
var numTiles = numCols * numRows;

var tileElements = [];
var tiles = [];

var numMoves = 0;

var emptyTileImage, dotImage;

function initTileElements() {
    var i;
    for (i = 0; i < numTiles; i++) {
        tileElements[i] = document.getElementById("tile" + i);
    }
}

var dotPositions = [
    [4],
    [0, 8],
    [0, 4, 8],
    [0, 2, 6, 8]
];
var dotTileSep = 13;
var dotMod = 3;
function drawTile(tileIndex) {
    console.log("Drawing tile " + tileIndex + " with value " + tiles[tileIndex]);
    var canvas = tileElements[tileIndex];
    var ctx = canvas.getContext("2d");
    ctx.drawImage(emptyTileImage, 0, 0, canvas.width, canvas.height);

    var i;
	var dotSep = (canvas.width - 2 * dotTileSep) / (dotMod - 1);
    var dots = dotPositions[tiles[tileIndex] - 1];
    for (i = 0; i < dots.length; i++) {
        var dotPos = dots[i];
		var dotx = dotTileSep + Math.floor(dotPos / dotMod) * dotSep - dotImage.width / 2;
		var doty = dotTileSep + (dotPos % dotMod) * dotSep - dotImage.height / 2;

        ctx.drawImage(dotImage, dotx, doty);
        console.log("  Dot at " + dotx + ", " + doty);
    }
}

function setTile(tileIndex, value) {
    tiles[tileIndex] = value;
    drawTile(tileIndex);
}

function displayStatus(statusText) {
    document.getElementById("status").innerHTML = statusText;
}

function setNumMoves(value) {
    numMoves = value;
    displayStatus(numMoves + " moves");
}

function resetPuzzle() {
    var i;
    for (i = 0; i < numTiles; i++) {
        setTile(i, numTiles - i);
    }
    setNumMoves(0);
}

function isPuzzleSolved() {
    var i;
    for (i = 0; i < numTiles; i++) {
        if (tiles[i] != (i + 1)) {
            return false;
        }
    }
    return true;
}

function canSwapTiles(t1, t2) {
    var sum = tiles[t1] + tiles[t2];
    return (sum % 3) == 0 || (sum % 5) == 0;
}

function swapTiles(t1, t2) {
    var value1 = tiles[t1];
    setTile(t1, tiles[t2]);
    setTile(t2, value1);
}

function trySwapTiles(t1, t2) {
    if (canSwapTiles(t1, t2)) {
        swapTiles(t1, t2);
        setNumMoves(numMoves + 1);
        if (isPuzzleSolved()) {
            displayStatus("Solved in " + numMoves + " moves!")
        }
    }
}

function preloadImages(srcs, imgs, callback) {
    var img;
    var remaining = srcs.length;
    for (var i = 0; i < srcs.length; i++) {
        img = new Image();
        img.onload = function() {
            --remaining;
            if (remaining <= 0) {
                callback();
            }
        };
        img.src = srcs[i];
        imgs.push(img);
    }
}

function loadTileImages(callback) {
    var tilePartImageSources = ["Images/Tile.png", "Images/Dot.png"];
    var tilePartImages = [];

    preloadImages(tilePartImageSources, tilePartImages, function() {
        emptyTileImage = tilePartImages[0];
        dotImage = tilePartImages[1];

        callback();
    });
}

function init() {
    displayStatus("Loading Images");

    loadTileImages(function() {
        initTileElements();
        resetPuzzle();
        displayStatus("Try me!")
    });
}
</script>
</html>