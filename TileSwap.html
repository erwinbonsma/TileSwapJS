<html>
<head>
<title>Tile Swap</title>
</head>
<body>

<h1>Puzzle</h1>

<table border="1">
<tr>
<td><canvas id="tile0" width="56" height="56"/></td>
<td><button onclick="trySwapTiles(0, 1)">-</button></td>
<td><canvas id="tile1" width="56" height="56"/></td>
</tr>
<tr>
<td><button onclick="trySwapTiles(0, 2)">|</button></td>
<td/>
<td><button onclick="trySwapTiles(1, 3)">|</button></td>
</tr>
<tr>
<td><canvas id="tile2" width="56" height="56"/></td>
<td><button onclick="trySwapTiles(2, 3)">-</button></td>
<td><canvas id="tile3" width="56" height="56"/></td>
</tr>
</table>

<!--
<canvas id="puzzleCanvas" width="200" height="200" />
-->

<p id="status">...</p>

<button onclick="resetPuzzle()">Reset</button>

<button onclick="init()">Initialize</button>

</body>

<script>
var puzzleModel;
var puzzleViewer;

function PuzzleModel(numCols, numRows) {
    this.numCols = numCols;
    this.numRows = numRows;
    this.numTiles = numCols * numRows;
    this.numMoves = 0;

    this.tiles = [];

    this.reset();
}

PuzzleModel.prototype.reset = function() {
    var i;
    for (i = 0; i < this.numTiles; i++) {
        this.tiles[i] = this.numTiles - i;
    }
    this.numMoves = 0;
}

PuzzleModel.prototype.isSolved = function() {
    var i;
    for (i = 0; i < this.numTiles; i++) {
        if (this.tiles[i] != (i + 1)) {
            return false;
        }
    }
    return true;
}

PuzzleModel.prototype.tileAt = function(tileIndex) {
    return this.tiles[tileIndex];
}

PuzzleModel.prototype.canSwapTiles = function(t1, t2) {
    var sum = this.tiles[t1] + this.tiles[t2];
    return (sum % 3) == 0 || (sum % 5) == 0;
}

PuzzleModel.prototype.swapTiles = function(t1, t2) {
    var value1 = this.tiles[t1];
    this.tiles[t1] = this.tiles[t2];
    this.tiles[t2] = value1;
}

PuzzleModel.prototype.trySwapTiles = function(t1, t2) {
    if (this.canSwapTiles(t1, t2)) {
        this.swapTiles(t1, t2);
        this.numMoves++;
        return true;
    }
    return false;
}

function PuzzleViewer(puzzleModel, emptyTileImage, dotImage) {
    this.model = puzzleModel;
    this.tileElements = [];
    this.emptyTileImage = emptyTileImage;
    this.dotImage = dotImage;

    this.dotPositions = [
        [4],
        [0, 8],
        [0, 4, 8],
        [0, 2, 6, 8]
    ];
    this.dotTileSep = 13;
    this.dotMod = 3;

    this.initTileElements();
}

PuzzleViewer.prototype.initTileElements = function() {
    var i;
    for (i = 0; i < this.model.numTiles; i++) {
        this.tileElements[i] = document.getElementById("tile" + i);
    }
}

PuzzleViewer.prototype.drawTile = function(tileIndex) {
    var canvas = this.tileElements[tileIndex];
    var ctx = canvas.getContext("2d");
    ctx.drawImage(this.emptyTileImage, 0, 0, canvas.width, canvas.height);

    var i;
	var dotSep = (canvas.width - 2 * this.dotTileSep) / (this.dotMod - 1);
    var dots = this.dotPositions[this.model.tileAt(tileIndex) - 1];
    var dotSize = this.dotImage.width;
    for (i = 0; i < dots.length; i++) {
        var dotPos = dots[i];
		var dotx = this.dotTileSep + Math.floor(dotPos / this.dotMod) * dotSep - dotSize / 2;
		var doty = this.dotTileSep + (dotPos % this.dotMod) * dotSep - dotSize / 2;

        ctx.drawImage(this.dotImage, dotx, doty);
    }
}

PuzzleViewer.prototype.drawPuzzle = function() {
    var i;
    for (i = 0; i < this.model.numTiles; i++) {
        this.drawTile(i);
    }
}

function displayStatus(statusText) {
    document.getElementById("status").innerHTML = statusText;
}

function preloadImages(srcs, imgs, callback) {
    var img;
    var remaining = srcs.length;
    for (var i = 0; i < srcs.length; i++) {
        img = new Image();
        img.onload = function() {
            --remaining;
            if (remaining <= 0) {
                callback();
            }
        };
        img.src = srcs[i];
        imgs.push(img);
    }
}

function init() {
    puzzleModel = new PuzzleModel(2, 2);

    displayStatus("Loading Images");
    var tileImages = [];
    preloadImages(
        ["Images/Tile.png", "Images/Dot.png"],
        tileImages,
        function() {
            puzzleViewer = new PuzzleViewer(puzzleModel, tileImages[0], tileImages[1]);

            puzzleViewer.drawPuzzle();
            displayStatus("Try me!");
        }
    );
}

function resetPuzzle() {
    puzzleModel.reset();
    puzzleViewer.drawPuzzle();
    displayStatus("Try again!");
}

function trySwapTiles(t1, t2) {
    if (puzzleModel.trySwapTiles(t1, t2)) {
        puzzleViewer.drawPuzzle();
        if (puzzleModel.isSolved()) {
            displayStatus("Solved in " + puzzleModel.numMoves + " moves!");
        } else {
            displayStatus(puzzleModel.numMoves + " moves");
        }
    }
}
</script>
</html>